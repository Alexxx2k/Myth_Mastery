<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.w3.org/1999/xhtml">
<head>
  <title>Журнал рейсов</title>
  <link rel="stylesheet" th:href="@{/css/tablesPages.css}">
</head>
<body>
<div class="container">
  <a th:href="@{/}" class="back-link">← Назад</a>
  <h1>Журнал рейсов</h1>

  <div th:if="${message}"
       th:class="${'success'.equals(messageType)} ? 'message success' : 'message error'"
       th:text="${message}">
  </div>

  <div sec:authorize="hasRole('ADMIN')" class="form-section">
    <h2>Начать рейс</h2>
    <form method="post" th:action="@{/journal/start}">
      <div class="form-group">
        <label for="autoId">Автомобиль:</label>
        <select id="autoId" name="autoId" required>
          <option value="">Выберите автомобиль</option>
          <option th:each="auto : ${autoList}"
                  th:value="${auto.id}"
                  th:text="${auto.num + ' (' + auto.mark + ')'}">
          </option>
        </select>
      </div>
      <div class="form-group">
        <label for="routeId">Маршрут:</label>
        <select id="routeId" name="routeId" required>
          <option value="">Выберите маршрут</option>
          <option th:each="route : ${routeList}"
                  th:value="${route.id}"
                  th:text="${route.name}">
          </option>
        </select>
      </div>
      <div class="form-group">
        <div class="custom-time">
          <label for="customTimeOut">Время начала:</label>
          <input type="datetime-local" id="customTimeOut" name="customTimeOut">
          <small>Оставьте пустым для использования текущего времени</small>
        </div>
      </div>
      <button type="submit" class="btn btn-primary">Начать рейс</button>
    </form>
  </div>

  <div sec:authorize="hasRole('ADMIN')" class="form-section">
    <h2>Завершить рейс</h2>
    <form method="post" th:action="@{/journal/end}">
      <div class="form-group">
        <label for="journalId">Запись в журнале:</label>
        <select id="journalId" name="journalId" required>
          <option value="">Выберите активный рейс</option>
          <option th:each="journal : ${journalList}"
                  th:if="${journal.timeIn() == null}"
                  th:value="${journal.id}"
                  th:text="'ID: ' + ${journal.id} + ' | Авто ID: ' + ${journal.autoId} + ' | Маршрут ID: ' + ${journal.routeId}">
          </option>
        </select>
      </div>
      <div class="form-group">
        <div class="custom-time">
          <label for="customTimeIn">Время завершения:</label>
          <input type="datetime-local" id="customTimeIn" name="customTimeIn">
          <small>Оставьте пустым для использования текущего времени</small>
        </div>
      </div>
      <button type="submit" class="btn btn-primary">Завершить рейс</button>
    </form>
  </div>

  <div sec:authorize="hasRole('ADMIN')" style="margin-top: 20px;">
    <a th:href="@{/journal/statistics}" class="btn btn-primary">Показать статистику</a>
  </div>

  <h2>История рейсов</h2>
  <table>
    <thead>
    <tr>
      <th>ID</th>
      <th>Время выезда</th>
      <th>Время возврата</th>
      <th>ID автомобиля</th>
      <th>ID маршрута</th>
      <th>Статус</th>
      <th sec:authorize="hasRole('ADMIN')">Действия</th>
    </tr>
    </thead>
    <tbody>
    <tr th:if="${#lists.isEmpty(journalList)}">
      <td colspan="7" class="no-data">Нет данных о рейсах</td>
    </tr>
    <tr th:each="journal : ${journalList}"
        th:class="${journal.timeIn() == null} ? 'active-trip' : 'completed-trip'">
      <td th:text="${journal.id}"></td>
      <td th:text="${#temporals.format(journal.timeOut, 'HH:mm dd-MM-yyyy')}"></td>
      <td>
        <span th:if="${journal.timeIn != null}" th:text="${#temporals.format(journal.timeIn, 'HH:mm dd-MM-yyyy')}"></span>
        <span th:if="${journal.timeIn == null}" style="color: red;">В рейсе</span>
      </td>
      <td th:text="${journal.autoId}"></td>
      <td th:text="${journal.routeId}"></td>
      <td>
        <span th:if="${journal.timeIn == null}" style="color: red;">АКТИВЕН</span>
        <span th:if="${journal.timeIn != null}" style="color: green;">ЗАВЕРШЕН</span>
      </td>
      <td sec:authorize="hasRole('ADMIN')" class="actions">
        <a th:href="@{/journal/edit/{id}(id=${journal.id})}" class="btn-edit">Редактировать</a>
        <form th:action="@{/journal/delete/{id}(id=${journal.id})}" method="post" style="display: inline;">
          <button type="submit" class="btn-delete"
                  onclick="return confirm('Вы уверены, что хотите удалить эту запись?')">
            Удалить
          </button>
        </form>
      </td>
    </tr>
    </tbody>
  </table>
</div>
</body>
</html>