<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Добавить продукт - MythMastery</title>
    <link rel="stylesheet" th:href="@{/css/createUpdatePages.css}">
    <link rel="stylesheet" th:href="@{/css/product.css}">
</head>
<body>
<div class="container">
    <a th:href="@{/products}" class="btn btn-secondary">← Назад к списку</a>
    <h1>Добавить продукт</h1>

    <div th:if="${message}"
         th:class="${'success'.equals(messageType)} ? 'message success' : 'message error'"
         th:text="${message}">
    </div>

    <form method="post" th:action="@{/products/create}" enctype="multipart/form-data" id="productForm">
        <div class="form-row">
            <div class="form-group">
                <label for="name">Название продукта *</label>
                <input type="text" id="name" name="name" required
                       placeholder="Например: Меч Тора, Щит Ахилла">
            </div>

            <div class="form-group">
                <label for="price">Цена (₽) *</label>
                <input type="number" id="price" name="price" required min="0" step="0.01" placeholder="0.00">
            </div>
        </div>

        <div class="form-row">
            <div class="form-group">
                <label for="categoryId">Категория *</label>
                <select id="categoryId" name="categoryId" required>
                    <option value="">-- Выберите категорию --</option>
                    <option th:each="category : ${categories}"
                            th:value="${category.id}"
                            th:text="${category.name}">
                    </option>
                </select>
            </div>

            <div class="form-group">
                <label for="mythologyId">Мифология *</label>
                <select id="mythologyId" name="mythologyId" required>
                    <option value="">-- Выберите мифологию --</option>
                    <option th:each="mythology : ${mythologies}"
                            th:value="${mythology.id}"
                            th:text="${mythology.name}">
                    </option>
                </select>
            </div>
        </div>

        <div class="form-group">
            <label for="description">Описание</label>
            <textarea id="description" name="description" rows="3" placeholder="Описание продукта..."></textarea>
        </div>

        <div class="form-group">
            <label for="imageFile">Изображение продукта</label>
            <div class="tab-container">
                <div class="tab active" onclick="switchTab('upload')">Загрузить</div>
                <div class="tab" onclick="switchTab('existing')">Выбрать из существующих</div>
                <div class="tab" onclick="switchTab('none')">Без изображения</div>
            </div>

            <div id="upload-tab" class="tab-content active">
                <input type="file" id="imageFile" name="imageFile" accept="image/*" onchange="previewImage(this)">
                <div class="preview-container">
                    <img id="imagePreview" class="preview-image" alt="Предпросмотр">
                </div>
            </div>

            <div id="existing-tab" class="tab-content">
                <div class="search-box">
                    <input type="text" id="imageSearch" placeholder="Поиск..." oninput="searchImages(this.value)">
                </div>
                <div id="imageGrid" class="image-grid">
                    <div th:each="image : ${existingImages}" class="image-item"
                         th:attr="data-url=${image.url}"
                         onclick="selectImage(this, this.getAttribute('data-url'))">
                        <img th:src="${image.url}" th:alt="${image.name}" onerror="this.style.display='none'">
                        <div class="image-name" th:text="${image.name}"></div>
                    </div>
                </div>
                <input type="hidden" id="selectedImageUrl" name="selectedImageUrl">
            </div>

            <div id="none-tab" class="tab-content">
                <p>Создать без изображения</p>
            </div>
        </div>

        <div class="button-group">
            <button type="submit" class="btn btn-primary">Добавить продукт</button>
        </div>
    </form>
</div>

<script>
    let currentTab = 'upload';
    let selectedImage = null;

    function switchTab(tab) {
        currentTab = tab;
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

        document.querySelector(`.tab:nth-child(${tab === 'upload' ? 1 : tab === 'existing' ? 2 : 3})`).classList.add('active');
        document.getElementById(tab + '-tab').classList.add('active');

        if (selectedImage && tab !== 'existing') {
            selectedImage.classList.remove('selected');
            selectedImage = null;
            document.getElementById('selectedImageUrl').value = '';
        }

        if (tab !== 'upload') {
            document.getElementById('imageFile').value = '';
            document.getElementById('imagePreview').style.display = 'none';
        }
    }

    function previewImage(input) {
        const preview = document.getElementById('imagePreview');
        if (input.files && input.files[0]) {
            preview.src = URL.createObjectURL(input.files[0]);
            preview.style.display = 'block';
        } else {
            preview.style.display = 'none';
        }
    }

    function selectImage(element, url) {
        if (selectedImage) selectedImage.classList.remove('selected');
        element.classList.add('selected');
        selectedImage = element;
        document.getElementById('selectedImageUrl').value = url;
    }

    function searchImages(term) {
        document.querySelectorAll('.image-item').forEach(item => {
            const name = item.querySelector('.image-name').textContent.toLowerCase();
            item.style.display = name.includes(term.toLowerCase()) ? 'block' : 'none';
        });
    }

    document.getElementById('productForm').addEventListener('submit', function(e) {
        if (currentTab === 'existing' && !selectedImage) {
            alert('Выберите изображение или переключите вкладку');
            e.preventDefault();
        }

        if (currentTab === 'upload' && !document.getElementById('imageFile').files.length) {
            if (!confirm('Продолжить без изображения?')) e.preventDefault();
        }
    });
</script>
</body>
</html>